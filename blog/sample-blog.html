<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/27776a8f4e4ebb98.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-889906d2d9470bce.js"/><script src="/_next/static/chunks/fd9d1056-2821b0f0cabcd8bd.js" async=""></script><script src="/_next/static/chunks/23-bc0704c1190bca24.js" async=""></script><script src="/_next/static/chunks/main-app-318f08948ed05f38.js" async=""></script><script src="/_next/static/chunks/173-452c45abe38fccea.js" async=""></script><script src="/_next/static/chunks/app/blog/sample-blog/page-c5ede1192827a959.js" async=""></script><script src="/_next/static/chunks/231-bea070b1ecddfbbc.js" async=""></script><script src="/_next/static/chunks/app/not-found-dcdfbe71b581895f.js" async=""></script><title>Jack Weller&#x27;s World</title><meta name="description" content="This is my world."/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body><header class="navbar sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-50 border-b border-gray-200"><div class="flex-1"><a class="btn btn-ghost text-xl">Jack Weller</a></div><div class="flex-none"><ul class="menu menu-horizontal px-1"><li><a>Blogs</a></li><li><details><summary>Projects</summary><ul class="bg-base-100 rounded-t-none p-2"><li><a>Visual</a></li><li><a>LEGO</a></li><li><a>CUDA</a></li></ul></details></li></ul></div></header><main class="container mx-auto my-5"><article class="prose max-w-screen-md"><h1>Pytorch DDP</h1>
<h2>DDP 是个啥</h2>
<h3>python GIL</h3>
<p>python 是通过引用计数做内存管理。<a href="https://realpython.com/python-gil/">GIL机制</a> 是所有线程共享一把锁。对于 multi-thread process，锁竞争大，效率不高。</p>
<h3>古早DP</h3>
<pre style="display:block;overflow-x:auto;padding:0.5em;color:#abb2bf;background:#282c34"><code class="language-python" style="white-space:pre"><span>model = torch.nn.DataParallel(model)
</span></code></pre>
<p>单进程多线程（受GIL限制），Parameter Server架构(PS主从模式)：server节点<em>scatter</em>参数到worker节点，<em>gather</em>接受所有worker节点计算的梯度，求和(all reduce)之后再scatter到worker节点。</p>
<p><img alt="image" loading="lazy" width="0" height="0" decoding="async" data-nimg="1" class="mx-auto" style="color:transparent;width:60%;height:auto" src="/blog/old-dp.png"/></p>
<p>DP中的一些通信语义是通过两卡间p2p通信实现的。</p>
<pre style="display:block;overflow-x:auto;padding:0.5em;color:#abb2bf;background:#282c34"><code class="language-cpp" style="white-space:pre"><span class="hljs-function">std::vector&lt;at::Tensor&gt; </span><span class="hljs-function" style="color:#61aeee">scatter</span><span class="hljs-function hljs-params">(
</span><span class="hljs-function hljs-params">    </span><span class="hljs-function hljs-params" style="color:#c678dd">const</span><span class="hljs-function hljs-params"> at::Tensor&amp; tensor, at::IntArrayRef devices,
</span><span class="hljs-function hljs-params">    </span><span class="hljs-function hljs-params" style="color:#c678dd">const</span><span class="hljs-function hljs-params"> c10::optional&lt;std::vector&lt;</span><span class="hljs-function hljs-params" style="color:#c678dd">int64_t</span><span class="hljs-function hljs-params">&gt;&gt;&amp; chunk_sizes, </span><span class="hljs-function hljs-params" style="color:#c678dd">int64_t</span><span class="hljs-function hljs-params"> dim,
</span><span class="hljs-function hljs-params">    </span><span class="hljs-function hljs-params" style="color:#c678dd">const</span><span class="hljs-function hljs-params"> c10::optional&lt;std::vector&lt;c10::optional&lt;at::cuda::CUDAStream&gt;&gt;&gt;&amp;
</span><span class="hljs-function hljs-params">        streams)</span><span class="hljs-function"> </span><span>{
</span><span>  </span><span style="color:#e6c07b">TORCH_CHECK</span><span>(!devices.</span><span style="color:#e6c07b">empty</span><span>(), </span><span style="color:#98c379">&quot;Expected at least one device to scatter to&quot;</span><span>);
</span><span>  </span><span style="color:#c678dd">if</span><span> (chunk_sizes.</span><span style="color:#e6c07b">has_value</span><span>()) {
</span><span>    </span><span style="color:#e6c07b">TORCH_CHECK</span><span>(
</span><span>        chunk_sizes-&gt;</span><span style="color:#e6c07b">size</span><span>() == devices.</span><span style="color:#e6c07b">size</span><span>(),
</span><span>        </span><span style="color:#98c379">&quot;Expected devices and chunk_sizes to be of same length, but got &quot;</span><span>
</span><span>        </span><span style="color:#98c379">&quot;len(devices) = &quot;</span><span>,
</span><span>        devices.</span><span style="color:#e6c07b">size</span><span>(), </span><span style="color:#98c379">&quot; and len(chunk_sizes) = &quot;</span><span>, chunk_sizes-&gt;</span><span style="color:#e6c07b">size</span><span>());
</span>  }
<span>  dim = at::</span><span style="color:#e6c07b">maybe_wrap_dim</span><span>(dim, tensor);
</span><span>  </span><span style="color:#5c6370;font-style:italic">// NOLINTNEXTLINE(cppcoreguidelines-init-variables)</span><span>
</span>  std::vector&lt;at::Tensor&gt; chunks =
<!-- -->      chunk_sizes
<span>          ? tensor.</span><span style="color:#e6c07b">split_with_sizes</span><span>(</span><span style="color:#5c6370;font-style:italic">/*split_sizes=*/</span><span>*chunk_sizes, </span><span style="color:#5c6370;font-style:italic">/*dim=*/</span><span>dim)
</span><span>          : tensor.</span><span style="color:#e6c07b">chunk</span><span>(</span><span style="color:#5c6370;font-style:italic">/*chunks=*/</span><span>devices.</span><span style="color:#e6c07b">size</span><span>(), </span><span style="color:#5c6370;font-style:italic">/*dim=*/</span><span>dim);
</span>  at::cuda::OptionalCUDAStreamGuard cuda_guard;
<span>  </span><span style="color:#c678dd">for</span><span> (</span><span style="color:#c678dd">const</span><span> </span><span style="color:#c678dd">auto</span><span> i : c10::</span><span style="color:#e6c07b">irange</span><span>(chunks.</span><span style="color:#e6c07b">size</span><span>())) {
</span><span>    </span><span style="color:#c678dd">const</span><span> </span><span style="color:#c678dd">auto</span><span> device_index = </span><span style="color:#c678dd">static_cast</span><span>&lt;</span><span style="color:#c678dd">int16_t</span><span>&gt;(devices[i]);
</span><span>    </span><span style="color:#c678dd">if</span><span> (device_index != tensor.</span><span style="color:#e6c07b">get_device</span><span>()) {
</span><span>      </span><span style="color:#c678dd">if</span><span> (i &lt; (streams ? streams-&gt;</span><span style="color:#e6c07b">size</span><span>() : </span><span style="color:#d19a66">0U</span><span>) &amp;&amp; (*streams)[i]) {
</span><span>        </span><span style="color:#e6c07b">TORCH_CHECK</span><span>((*streams)[i]-&gt;</span><span style="color:#e6c07b">device_index</span><span>() == device_index,
</span><span>                    </span><span style="color:#98c379">&quot;Expected the device associated with the stream at index &quot;</span><span>,
</span><span>                    i, </span><span style="color:#98c379">&quot; (was &quot;</span><span>, (*streams)[i]-&gt;</span><span style="color:#e6c07b">device_index</span><span>(), </span><span style="color:#98c379">&quot;) &quot;</span><span>,
</span><span>                    </span><span style="color:#98c379">&quot;to match the device supplied at that index &quot;</span><span>, </span><span style="color:#98c379">&quot;(expected &quot;</span><span>,
</span><span>                    device_index, </span><span style="color:#98c379">&quot;)&quot;</span><span>);
</span><span>        cuda_guard.</span><span style="color:#e6c07b">reset_stream</span><span>(*(*streams)[i]);
</span>      }
<span>      </span><span style="color:#e6c07b">TORCH_CHECK</span><span>(device_index &gt;= </span><span style="color:#d19a66">0</span><span>,
</span><span>                  </span><span style="color:#98c379">&quot;Expected non-negative device index, but got &quot;</span><span>, device_index);
</span><span>      </span><span style="color:#5c6370;font-style:italic">// 简单通过copy来实现跨GPU拷贝</span><span>
</span><span>      chunks[i] = chunks[i].</span><span style="color:#e6c07b">to</span><span>({DeviceType::CUDA, device_index},
</span><span>                               </span><span style="color:#5c6370;font-style:italic">/*non_blocking=*/</span><span style="color:#56b6c2">true</span><span>,
</span><span>                               </span><span style="color:#5c6370;font-style:italic">/*copy=*/</span><span style="color:#56b6c2">false</span><span>,
</span><span>                               </span><span style="color:#5c6370;font-style:italic">/*memory_format=*/</span><span>at::MemoryFormat::Preserve);
</span>    }
<!-- -->  }
<span>  </span><span style="color:#c678dd">return</span><span> chunks;
</span>}
</code></pre>
<p>在cuda copy 算子实现中：</p>
<ol>
<li>先检测两卡之间是否可以点对点通信</li>
<li>可以点对点通信之后，再做D2D拷贝：cudamemcpy/cudamemcpyAsync</li>
</ol>
<p><img alt="image" loading="lazy" width="0" height="0" decoding="async" data-nimg="1" class="mx-auto" style="color:transparent;width:60%;height:auto" src="/blog/copy_kernel_cuda.png"/></p>
<p><strong>Notice</strong>:
可能没有办法在DP 通信算子里使用collective communicatore。
XMLIR栈：可能可以借助cpu：xpu 0-&gt;cpu-&gt;xpu1类似cuda copy算子。</p>
<h3>InitProcessGroup</h3>
<p>其实就是对Process group设置属性：https://pytorch.org/docs/stable/distributed.html</p>
<ul>
<li>world_size: 进程数</li>
<li>rank: 进程序号, [0, world_size-1]</li>
<li>local_rank: 进程内的卡id，torch.distributed.launch 时候指定的。</li>
<li>MASTER_ADDR：rank0(master) 地址</li>
<li>MASTER_PORT：rank0(master) 端口号</li>
<li>init_method：URL，寻找peers。三种模式：TCP， FILE，ENV(master addr + master port 拼)</li>
</ul>
<p>单机2卡：world_size: 2;  rank: [0, 1];  local_rank: [0, 1]</p>
<p>2机8卡：world_size: 16, rank: [0, 1, ...., 15];   node 0: local_rank: [0, 1, ..7],  node1 : local_rank[0, 1, ... 7]</p>
<h3>DDP</h3>
<ol>
<li>torch DDP 采用是多进程，每个进程一张卡，绕过GIL限制。</li>
<li>ring reduce 算法梯度更新</li>
<li>model parallel，data parallel</li>
</ol>
<pre style="display:block;overflow-x:auto;padding:0.5em;color:#abb2bf;background:#282c34"><code class="language-python" style="white-space:pre"><span style="color:#5c6370;font-style:italic">## ddp example</span><span>
</span><span>dist.init_process_group(</span><span style="color:#98c379">&quot;xccl&quot;</span><span>, rank=rank, world_size=world_size
</span><span></span><span style="color:#5c6370;font-style:italic"># create model and move it to GPU with id rank</span><span>
</span>model = ToyModel().to(rank)
<!-- -->ddp_model = DDP(model, device_ids=[rank])
</code></pre>
<h2>DDP 原理+源码实现</h2>
<h3>数据一致性</h3>
<p>参数平均：优化器执行之后所有模型的参数求平均。backward计算和通信无法并行；梯度下降方向不一样；数学不等价。</p>
<p>梯度平均：所有模型梯度求平均，之后每个进程更新。计算和通信可以并行，数学等价</p>
<h3>总结构</h3>
<p>DDP 每个进程拥有模型副本，优化器。所有进程的模型副本初始化状态相同，优化器每次step的梯度相同。</p>
<p><img alt="image" loading="lazy" width="0" height="0" decoding="async" data-nimg="1" class="mx-auto" style="color:transparent;width:60%;height:auto" src="/blog/ddp1.png"/></p>
<p><img alt="image" loading="lazy" width="0" height="0" decoding="async" data-nimg="1" class="mx-auto" style="color:transparent;width:60%;height:auto" src="/blog/ddp2.png"/></p>
<p>数据并行以nn.module为基础:</p>
<pre style="display:block;overflow-x:auto;padding:0.5em;color:#abb2bf;background:#282c34"><code class="language-python" style="white-space:pre"><span>ddp_model = DDP(model, device_ids=[rank])
</span></code></pre>
<p>分布式模型替代本地模型，拦截forward()调用相应的分布式forward操作。反向时依靠autograd engine 调用backwad hook（参数中检索梯度张量）触发gradient reduce (代码实现在reducer.cpp)。</p></article></main><footer class="footer footer-center bg-neutral text-neutral-content p-10"><aside><p class="font-bold">求知若渴。<br/>Eager to learn.</p><p>Copyright © <!-- -->2024<!-- --> - Jack Weller</p></aside><nav><div class="grid grid-flow-col gap-4"><a class="logo-github" href="https://github.com/ipython3" title="GitHub" target="_blank" rel="noopener noreferrer"><svg class="fill-current hover:fill-[#9244f8]" viewBox="0 0 496 512" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a class="logo-linkedin" href="https://www.linkedin.com" title="LinkedIn" target="_blank" rel="noopener noreferrer"><svg class="fill-current hover:fill-[#2265f5]" height="24" width="24" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></div></nav></footer><script src="/_next/static/chunks/webpack-889906d2d9470bce.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/27776a8f4e4ebb98.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"2:I[5751,[],\"\"]\n4:I[8173,[\"173\",\"static/chunks/173-452c45abe38fccea.js\",\"307\",\"static/chunks/app/blog/sample-blog/page-c5ede1192827a959.js\"],\"Image\"]\n5:I[9275,[],\"\"]\n6:I[1343,[],\"\"]\n7:I[231,[\"231\",\"static/chunks/231-bea070b1ecddfbbc.js\",\"160\",\"static/chunks/app/not-found-dcdfbe71b581895f.js\"],\"\"]\na:I[6130,[],\"\"]\n8:T518,M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2zb:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/27776a8f4e4ebb98.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L2\",null,{\"buildId\":\"zjB84wIh9J-vXvi_0JkmE\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/blog/sample-blog\",\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[\"sample-blog\",{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[\"sample-blog\",{\"children\":[\"__PAGE__\",{},[[\"$L3\",[[\"$\",\"h1\",null,{\"children\":\"Pytorch DDP\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"DDP 是个啥\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"python GIL\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"python 是通过引用计数做内存管理。\",[\"$\",\"a\",null,{\"href\":\"https://realpython.com/python-gil/\",\"children\":\"GIL机制\"}],\" 是所有线程共享一把锁。对于 multi-thread process，锁竞争大，效率不高。\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"古早DP\"}],\"\\n\",[\"$\",\"pre\",null,{\"style\":{\"display\":\"block\",\"overflowX\":\"auto\",\"padding\":\"0.5em\",\"color\":\"#abb2bf\",\"background\":\"#282c34\"},\"children\":[\"$\",\"code\",null,{\"className\":\"language-python\",\"style\":{\"whiteSpace\":\"pre\"},\"children\":[false,[[\"$\",\"span\",\"code-segement0\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"model = torch.nn.DataParallel(model)\\n\"]}],\"\"]]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"单进程多线程（受GIL限制），Parameter Server架构(PS主从模式)：server节点\",[\"$\",\"em\",null,{\"children\":\"scatter\"}],\"参数到worker节点，\",[\"$\",\"em\",null,{\"children\":\"gather\"}],\"接受所有worker节点计算的梯度，求和(all reduce)之后再scatter到worker节点。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"$L4\",null,{\"src\":\"/blog/old-dp.png\",\"alt\":\"image\",\"width\":0,\"height\":0,\"style\":{\"width\":\"60%\",\"height\":\"auto\"},\"className\":\"mx-auto\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"DP中的一些通信语义是通过两卡间p2p通信实现的。\"}],\"\\n\",[\"$\",\"pre\",null,{\"style\":{\"display\":\"block\",\"overflowX\":\"auto\",\"padding\":\"0.5em\",\"color\":\"#abb2bf\",\"background\":\"#282c34\"},\"children\":[\"$\",\"code\",null,{\"className\":\"language-cpp\",\"style\":{\"whiteSpace\":\"pre\"},\"children\":[false,[[\"$\",\"span\",\"code-segement0\",{\"className\":\"hljs-function\",\"style\":{},\"children\":[\"std::vector\u003cat::Tensor\u003e \"]}],[\"$\",\"span\",\"code-segement1\",{\"className\":\"hljs-function\",\"style\":{\"color\":\"#61aeee\"},\"children\":[\"scatter\"]}],[\"$\",\"span\",\"code-segement2\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\"(\\n\"]}],[\"$\",\"span\",\"code-segement3\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement4\",{\"className\":\"hljs-function hljs-params\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"const\"]}],[\"$\",\"span\",\"code-segement5\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\" at::Tensor\u0026 tensor, at::IntArrayRef devices,\\n\"]}],[\"$\",\"span\",\"code-segement6\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement7\",{\"className\":\"hljs-function hljs-params\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"const\"]}],[\"$\",\"span\",\"code-segement8\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\" c10::optional\u003cstd::vector\u003c\"]}],[\"$\",\"span\",\"code-segement9\",{\"className\":\"hljs-function hljs-params\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"int64_t\"]}],[\"$\",\"span\",\"code-segement10\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\"\u003e\u003e\u0026 chunk_sizes, \"]}],[\"$\",\"span\",\"code-segement11\",{\"className\":\"hljs-function hljs-params\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"int64_t\"]}],[\"$\",\"span\",\"code-segement12\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\" dim,\\n\"]}],[\"$\",\"span\",\"code-segement13\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement14\",{\"className\":\"hljs-function hljs-params\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"const\"]}],[\"$\",\"span\",\"code-segement15\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\" c10::optional\u003cstd::vector\u003cc10::optional\u003cat::cuda::CUDAStream\u003e\u003e\u003e\u0026\\n\"]}],[\"$\",\"span\",\"code-segement16\",{\"className\":\"hljs-function hljs-params\",\"style\":{},\"children\":[\"        streams)\"]}],[\"$\",\"span\",\"code-segement17\",{\"className\":\"hljs-function\",\"style\":{},\"children\":[\" \"]}],[\"$\",\"span\",\"code-segement18\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"{\\n\"]}],[\"$\",\"span\",\"code-segement19\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"  \"]}],[\"$\",\"span\",\"code-segement20\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"TORCH_CHECK\"]}],[\"$\",\"span\",\"code-segement21\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(!devices.\"]}],[\"$\",\"span\",\"code-segement22\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"empty\"]}],[\"$\",\"span\",\"code-segement23\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(), \"]}],[\"$\",\"span\",\"code-segement24\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\"Expected at least one device to scatter to\\\"\"]}],[\"$\",\"span\",\"code-segement25\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\");\\n\"]}],[\"$\",\"span\",\"code-segement26\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"  \"]}],[\"$\",\"span\",\"code-segement27\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"if\"]}],[\"$\",\"span\",\"code-segement28\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" (chunk_sizes.\"]}],[\"$\",\"span\",\"code-segement29\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"has_value\"]}],[\"$\",\"span\",\"code-segement30\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"()) {\\n\"]}],[\"$\",\"span\",\"code-segement31\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement32\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"TORCH_CHECK\"]}],[\"$\",\"span\",\"code-segement33\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(\\n\"]}],[\"$\",\"span\",\"code-segement34\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"        chunk_sizes-\u003e\"]}],[\"$\",\"span\",\"code-segement35\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"size\"]}],[\"$\",\"span\",\"code-segement36\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"() == devices.\"]}],[\"$\",\"span\",\"code-segement37\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"size\"]}],[\"$\",\"span\",\"code-segement38\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(),\\n\"]}],[\"$\",\"span\",\"code-segement39\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"        \"]}],[\"$\",\"span\",\"code-segement40\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\"Expected devices and chunk_sizes to be of same length, but got \\\"\"]}],[\"$\",\"span\",\"code-segement41\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement42\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"        \"]}],[\"$\",\"span\",\"code-segement43\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\"len(devices) = \\\"\"]}],[\"$\",\"span\",\"code-segement44\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\",\\n\"]}],[\"$\",\"span\",\"code-segement45\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"        devices.\"]}],[\"$\",\"span\",\"code-segement46\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"size\"]}],[\"$\",\"span\",\"code-segement47\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(), \"]}],[\"$\",\"span\",\"code-segement48\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\" and len(chunk_sizes) = \\\"\"]}],[\"$\",\"span\",\"code-segement49\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\", chunk_sizes-\u003e\"]}],[\"$\",\"span\",\"code-segement50\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"size\"]}],[\"$\",\"span\",\"code-segement51\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"());\\n\"]}],\"  }\\n\",[\"$\",\"span\",\"code-segement53\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"  dim = at::\"]}],[\"$\",\"span\",\"code-segement54\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"maybe_wrap_dim\"]}],[\"$\",\"span\",\"code-segement55\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(dim, tensor);\\n\"]}],[\"$\",\"span\",\"code-segement56\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"  \"]}],[\"$\",\"span\",\"code-segement57\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"// NOLINTNEXTLINE(cppcoreguidelines-init-variables)\"]}],[\"$\",\"span\",\"code-segement58\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],\"  std::vector\u003cat::Tensor\u003e chunks =\\n\",\"      chunk_sizes\\n\",[\"$\",\"span\",\"code-segement61\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"          ? tensor.\"]}],[\"$\",\"span\",\"code-segement62\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"split_with_sizes\"]}],[\"$\",\"span\",\"code-segement63\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(\"]}],[\"$\",\"span\",\"code-segement64\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"/*split_sizes=*/\"]}],[\"$\",\"span\",\"code-segement65\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"*chunk_sizes, \"]}],[\"$\",\"span\",\"code-segement66\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"/*dim=*/\"]}],[\"$\",\"span\",\"code-segement67\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"dim)\\n\"]}],[\"$\",\"span\",\"code-segement68\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"          : tensor.\"]}],[\"$\",\"span\",\"code-segement69\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"chunk\"]}],[\"$\",\"span\",\"code-segement70\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(\"]}],[\"$\",\"span\",\"code-segement71\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"/*chunks=*/\"]}],[\"$\",\"span\",\"code-segement72\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"devices.\"]}],[\"$\",\"span\",\"code-segement73\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"size\"]}],[\"$\",\"span\",\"code-segement74\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(), \"]}],[\"$\",\"span\",\"code-segement75\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"/*dim=*/\"]}],[\"$\",\"span\",\"code-segement76\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"dim);\\n\"]}],\"  at::cuda::OptionalCUDAStreamGuard cuda_guard;\\n\",[\"$\",\"span\",\"code-segement78\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"  \"]}],[\"$\",\"span\",\"code-segement79\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"for\"]}],[\"$\",\"span\",\"code-segement80\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" (\"]}],[\"$\",\"span\",\"code-segement81\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"const\"]}],[\"$\",\"span\",\"code-segement82\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" \"]}],[\"$\",\"span\",\"code-segement83\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"auto\"]}],[\"$\",\"span\",\"code-segement84\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" i : c10::\"]}],[\"$\",\"span\",\"code-segement85\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"irange\"]}],[\"$\",\"span\",\"code-segement86\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(chunks.\"]}],[\"$\",\"span\",\"code-segement87\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"size\"]}],[\"$\",\"span\",\"code-segement88\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"())) {\\n\"]}],[\"$\",\"span\",\"code-segement89\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement90\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"const\"]}],[\"$\",\"span\",\"code-segement91\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" \"]}],[\"$\",\"span\",\"code-segement92\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"auto\"]}],[\"$\",\"span\",\"code-segement93\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" device_index = \"]}],[\"$\",\"span\",\"code-segement94\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"static_cast\"]}],[\"$\",\"span\",\"code-segement95\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\u003c\"]}],[\"$\",\"span\",\"code-segement96\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"int16_t\"]}],[\"$\",\"span\",\"code-segement97\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\u003e(devices[i]);\\n\"]}],[\"$\",\"span\",\"code-segement98\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement99\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"if\"]}],[\"$\",\"span\",\"code-segement100\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" (device_index != tensor.\"]}],[\"$\",\"span\",\"code-segement101\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"get_device\"]}],[\"$\",\"span\",\"code-segement102\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"()) {\\n\"]}],[\"$\",\"span\",\"code-segement103\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"      \"]}],[\"$\",\"span\",\"code-segement104\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"if\"]}],[\"$\",\"span\",\"code-segement105\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" (i \u003c (streams ? streams-\u003e\"]}],[\"$\",\"span\",\"code-segement106\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"size\"]}],[\"$\",\"span\",\"code-segement107\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"() : \"]}],[\"$\",\"span\",\"code-segement108\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#d19a66\"},\"children\":[\"0U\"]}],[\"$\",\"span\",\"code-segement109\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\") \u0026\u0026 (*streams)[i]) {\\n\"]}],[\"$\",\"span\",\"code-segement110\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"        \"]}],[\"$\",\"span\",\"code-segement111\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"TORCH_CHECK\"]}],[\"$\",\"span\",\"code-segement112\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"((*streams)[i]-\u003e\"]}],[\"$\",\"span\",\"code-segement113\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"device_index\"]}],[\"$\",\"span\",\"code-segement114\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"() == device_index,\\n\"]}],[\"$\",\"span\",\"code-segement115\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"                    \"]}],[\"$\",\"span\",\"code-segement116\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\"Expected the device associated with the stream at index \\\"\"]}],[\"$\",\"span\",\"code-segement117\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\",\\n\"]}],[\"$\",\"span\",\"code-segement118\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"                    i, \"]}],[\"$\",\"span\",\"code-segement119\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\" (was \\\"\"]}],[\"$\",\"span\",\"code-segement120\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\", (*streams)[i]-\u003e\"]}],[\"$\",\"span\",\"code-segement121\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"device_index\"]}],[\"$\",\"span\",\"code-segement122\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(), \"]}],[\"$\",\"span\",\"code-segement123\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\") \\\"\"]}],[\"$\",\"span\",\"code-segement124\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\",\\n\"]}],[\"$\",\"span\",\"code-segement125\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"                    \"]}],[\"$\",\"span\",\"code-segement126\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\"to match the device supplied at that index \\\"\"]}],[\"$\",\"span\",\"code-segement127\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\", \"]}],[\"$\",\"span\",\"code-segement128\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\"(expected \\\"\"]}],[\"$\",\"span\",\"code-segement129\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\",\\n\"]}],[\"$\",\"span\",\"code-segement130\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"                    device_index, \"]}],[\"$\",\"span\",\"code-segement131\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\")\\\"\"]}],[\"$\",\"span\",\"code-segement132\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\");\\n\"]}],[\"$\",\"span\",\"code-segement133\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"        cuda_guard.\"]}],[\"$\",\"span\",\"code-segement134\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"reset_stream\"]}],[\"$\",\"span\",\"code-segement135\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(*(*streams)[i]);\\n\"]}],\"      }\\n\",[\"$\",\"span\",\"code-segement137\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"      \"]}],[\"$\",\"span\",\"code-segement138\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"TORCH_CHECK\"]}],[\"$\",\"span\",\"code-segement139\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"(device_index \u003e= \"]}],[\"$\",\"span\",\"code-segement140\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#d19a66\"},\"children\":[\"0\"]}],[\"$\",\"span\",\"code-segement141\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\",\\n\"]}],[\"$\",\"span\",\"code-segement142\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"                  \"]}],[\"$\",\"span\",\"code-segement143\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\"Expected non-negative device index, but got \\\"\"]}],[\"$\",\"span\",\"code-segement144\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\", device_index);\\n\"]}],[\"$\",\"span\",\"code-segement145\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"      \"]}],[\"$\",\"span\",\"code-segement146\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"// 简单通过copy来实现跨GPU拷贝\"]}],[\"$\",\"span\",\"code-segement147\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement148\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"      chunks[i] = chunks[i].\"]}],[\"$\",\"span\",\"code-segement149\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#e6c07b\"},\"children\":[\"to\"]}],[\"$\",\"span\",\"code-segement150\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"({DeviceType::CUDA, device_index},\\n\"]}],[\"$\",\"span\",\"code-segement151\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"                               \"]}],[\"$\",\"span\",\"code-segement152\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"/*non_blocking=*/\"]}],[\"$\",\"span\",\"code-segement153\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#56b6c2\"},\"children\":[\"true\"]}],[\"$\",\"span\",\"code-segement154\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\",\\n\"]}],[\"$\",\"span\",\"code-segement155\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"                               \"]}],[\"$\",\"span\",\"code-segement156\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"/*copy=*/\"]}],[\"$\",\"span\",\"code-segement157\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#56b6c2\"},\"children\":[\"false\"]}],[\"$\",\"span\",\"code-segement158\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\",\\n\"]}],[\"$\",\"span\",\"code-segement159\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"                               \"]}],[\"$\",\"span\",\"code-segement160\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"/*memory_format=*/\"]}],[\"$\",\"span\",\"code-segement161\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"at::MemoryFormat::Preserve);\\n\"]}],\"    }\\n\",\"  }\\n\",[\"$\",\"span\",\"code-segement164\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"  \"]}],[\"$\",\"span\",\"code-segement165\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#c678dd\"},\"children\":[\"return\"]}],[\"$\",\"span\",\"code-segement166\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" chunks;\\n\"]}],\"}\\n\",\"\"]]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"在cuda copy 算子实现中：\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"先检测两卡之间是否可以点对点通信\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"可以点对点通信之后，再做D2D拷贝：cudamemcpy/cudamemcpyAsync\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"$L4\",null,{\"src\":\"/blog/copy_kernel_cuda.png\",\"alt\":\"image\",\"width\":0,\"height\":0,\"style\":{\"width\":\"60%\",\"height\":\"auto\"},\"className\":\"mx-auto\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Notice\"}],\":\\n可能没有办法在DP 通信算子里使用collective communicatore。\\nXMLIR栈：可能可以借助cpu：xpu 0-\u003ecpu-\u003expu1类似cuda copy算子。\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"InitProcessGroup\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"其实就是对Process group设置属性：https://pytorch.org/docs/stable/distributed.html\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"world_size: 进程数\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"rank: 进程序号, [0, world_size-1]\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"local_rank: 进程内的卡id，torch.distributed.launch 时候指定的。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"MASTER_ADDR：rank0(master) 地址\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"MASTER_PORT：rank0(master) 端口号\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"init_method：URL，寻找peers。三种模式：TCP， FILE，ENV(master addr + master port 拼)\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"单机2卡：world_size: 2;  rank: [0, 1];  local_rank: [0, 1]\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"2机8卡：world_size: 16, rank: [0, 1, ...., 15];   node 0: local_rank: [0, 1, ..7],  node1 : local_rank[0, 1, ... 7]\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"DDP\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"torch DDP 采用是多进程，每个进程一张卡，绕过GIL限制。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"ring reduce 算法梯度更新\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"model parallel，data parallel\"}],\"\\n\"]}],\"\\n\",[\"$\",\"pre\",null,{\"style\":{\"display\":\"block\",\"overflowX\":\"auto\",\"padding\":\"0.5em\",\"color\":\"#abb2bf\",\"background\":\"#282c34\"},\"children\":[\"$\",\"code\",null,{\"className\":\"language-python\",\"style\":{\"whiteSpace\":\"pre\"},\"children\":[false,[[\"$\",\"span\",\"code-segement0\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"## ddp example\"]}],[\"$\",\"span\",\"code-segement1\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement2\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"dist.init_process_group(\"]}],[\"$\",\"span\",\"code-segement3\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#98c379\"},\"children\":[\"\\\"xccl\\\"\"]}],[\"$\",\"span\",\"code-segement4\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\", rank=rank, world_size=world_size\\n\"]}],[\"$\",\"span\",\"code-segement5\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\"]}],[\"$\",\"span\",\"code-segement6\",{\"className\":\"$undefined\",\"style\":{\"color\":\"#5c6370\",\"fontStyle\":\"italic\"},\"children\":[\"# create model and move it to GPU with id rank\"]}],[\"$\",\"span\",\"code-segement7\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],\"model = ToyModel().to(rank)\\n\",\"ddp_model = DDP(model, device_ids=[rank])\\n\",\"\"]]}]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"DDP 原理+源码实现\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"数据一致性\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"参数平均：优化器执行之后所有模型的参数求平均。backward计算和通信无法并行；梯度下降方向不一样；数学不等价。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"梯度平均：所有模型梯度求平均，之后每个进程更新。计算和通信可以并行，数学等价\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"总结构\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"DDP 每个进程拥有模型副本，优化器。所有进程的模型副本初始化状态相同，优化器每次step的梯度相同。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"$L4\",null,{\"src\":\"/blog/ddp1.png\",\"alt\":\"image\",\"width\":0,\"height\":0,\"style\":{\"width\":\"60%\",\"height\":\"auto\"},\"className\":\"mx-auto\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"$L4\",null,{\"src\":\"/blog/ddp2.png\",\"alt\":\"image\",\"width\":0,\"height\":0,\"style\":{\"width\":\"60%\",\"height\":\"auto\"},\"className\":\"mx-auto\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"数据并行以nn.module为基础:\"}],\"\\n\",[\"$\",\"pre\",null,{\"style\":{\"display\":\"block\",\"overflowX\":\"auto\",\"padding\":\"0.5em\",\"color\":\"#abb2bf\",\"background\":\"#282c34\"},\"children\":[\"$\",\"code\",null,{\"className\":\"language-python\",\"style\":{\"whiteSpace\":\"pre\"},\"children\":[false,[[\"$\",\"span\",\"code-segement0\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"ddp_model = DDP(model, device_ids=[rank])\\n\"]}],\"\"]]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"分布式模型替代本地模型，拦截forward()调用相应的分布式forward操作。反向时依靠autograd engine 调用backwad hook（参数中检索梯度张量）触发gradient reduce (代码实现在reducer.cpp)。\"}]]],null],null]},[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"sample-blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"main\",null,{\"className\":\"container mx-auto my-5\",\"children\":[\"$\",\"article\",null,{\"className\":\"prose max-w-screen-md\",\"children\":[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]}]}],null],null]},[[\"$\",\"html\",null,{\"children\":[\"$\",\"body\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\"navbar sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-50 border-b border-gray-200\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex-1\",\"children\":[\"$\",\"a\",null,{\"className\":\"btn btn-ghost text-xl\",\"children\":\"Jack Weller\"}]}],[\"$\",\"div\",null,{\"className\":\"flex-none\",\"children\":[\"$\",\"ul\",null,{\"className\":\"menu menu-horizontal px-1\",\"children\":[[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"children\":\"Blogs\"}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"details\",null,{\"children\":[[\"$\",\"summary\",null,{\"children\":\"Projects\"}],[\"$\",\"ul\",null,{\"className\":\"bg-base-100 rounded-t-none p-2\",\"children\":[[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"children\":\"Visual\"}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"children\":\"LEGO\"}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"children\":\"CUDA\"}]}]]}]]}]}]]}]}]]}],[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"main\",null,{\"className\":\"container mx-auto my-5\",\"children\":[\"$\",\"article\",null,{\"className\":\"prose max-w-screen-lg\",\"children\":[[\"$\",\"h1\",null,{\"children\":\"Not Found\"}],[\"$\",\"p\",null,{\"children\":\"Could not find requested resource\"}],[\"$\",\"$L7\",null,{\"href\":\"/\",\"children\":\"Return Home\"}]]}]}],\"notFoundStyles\":[],\"styles\":null}],[\"$\",\"footer\",null,{\"className\":\"footer footer-center bg-neutral text-neutral-content p-10\",\"children\":[[\"$\",\"aside\",null,{\"children\":[[\"$\",\"p\",null,{\"className\":\"font-bold\",\"children\":[\"求知若渴。\",[\"$\",\"br\",null,{}],\"Eager to learn.\"]}],[\"$\",\"p\",null,{\"children\":[\"Copyright © \",2024,\" - Jack Weller\"]}]]}],[\"$\",\"nav\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"grid grid-flow-col gap-4\",\"children\":[[\"$\",\"a\",null,{\"className\":\"logo-github\",\"href\":\"https://github.com/ipython3\",\"title\":\"GitHub\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"children\":[\"$\",\"svg\",null,{\"className\":\"fill-current hover:fill-[#9244f8]\",\"viewBox\":\"0 0 496 512\",\"height\":\"24\",\"width\":\"24\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"$8\"}]}]}],[\"$\",\"a\",null,{\"className\":\"logo-linkedin\",\"href\":\"https://www.linkedin.com\",\"title\":\"LinkedIn\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"children\":[\"$\",\"svg\",null,{\"className\":\"fill-current hover:fill-[#2265f5]\",\"height\":\"24\",\"width\":\"24\",\"viewBox\":\"0 0 448 512\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z\"}]}]}]]}]}]]}]]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$L9\"],\"globalErrorComponent\":\"$a\",\"missingSlots\":\"$Wb\"}]]\n"])</script><script>self.__next_f.push([1,"9:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Jack Weller's World\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"This is my world.\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}]]\n3:null\n"])</script></body></html>